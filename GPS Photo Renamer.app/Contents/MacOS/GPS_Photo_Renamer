#!/bin/bash
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# GPS Photo Renamer - UI Version v2.3.0
# Renames photos based on GPS EXIF data with native macOS dialogs
# v2.1.0: Video detection and deletion option
# v2.2.0: Map tile watermark from OpenStreetMap
# v2.3.0: Map option dialog, reprocess existing photos, _MAP tag, bigger map

# Funktion f√ºr Benachrichtigungen
notify() {
    osascript -e "display notification \"$2\" with title \"GPS Photo Renamer\" subtitle \"$1\""
}

# Funktion f√ºr Dialogs
show_dialog() {
    osascript -e "display dialog \"$1\" with title \"GPS Photo Renamer\" buttons {\"OK\"} default button 1"
}

# Funktion f√ºr Fehler-Dialogs
show_error() {
    osascript -e "display dialog \"‚ùå Fehler: $1\" with title \"GPS Photo Renamer\" buttons {\"OK\"} default button 1 with icon stop"
}

# Logging
LOG_FILE="$HOME/Desktop/gps_photo_renamer.log"
exec > "$LOG_FILE" 2>&1

echo "=== GPS Photo Renamer v2.3.0 ==="
echo "$(date)"
echo ""

# Schritt 1: Pr√ºfe und installiere Dependencies
notify "Pr√ºfe System" "√úberpr√ºfe installierte Tools..."

INSTALL_FAILED=0

# Pr√ºfe Python
if ! command -v python3 &> /dev/null; then
    show_error "Python 3 nicht gefunden!\n\nBitte installiere Python 3:\nbrew install python3"
    exit 1
fi

# Pr√ºfe Pillow
if ! python3 -c "from PIL import Image" 2>/dev/null; then
    notify "Installation" "Installiere Pillow..."

    if ! pip3 install Pillow --break-system-packages 2>&1; then
        show_error "Pillow Installation fehlgeschlagen!\n\nBitte installiere manuell:\npip3 install Pillow --break-system-packages"
        INSTALL_FAILED=1
    fi
fi

# Pr√ºfe requests
if ! python3 -c "import requests" 2>/dev/null; then
    notify "Installation" "Installiere requests..."

    if ! pip3 install requests --break-system-packages 2>&1; then
        show_error "requests Installation fehlgeschlagen!\n\nBitte installiere manuell:\npip3 install requests --break-system-packages"
        INSTALL_FAILED=1
    fi
fi

if [ $INSTALL_FAILED -eq 1 ]; then
    osascript <<'HELP_DIALOG'
display dialog "‚ö†Ô∏è Installation fehlgeschlagen!

üìã Bitte f√ºhre die folgenden Schritte MANUELL aus:

1Ô∏è‚É£ Python 3 installieren (falls nicht vorhanden):
   brew install python3

2Ô∏è‚É£ Python-Pakete installieren:
   pip3 install Pillow requests --break-system-packages

üìÑ Details im Log: ~/Desktop/gps_photo_renamer.log

Nach der manuellen Installation die App erneut starten!" buttons {"OK"} default button 1 with title "GPS Photo Renamer - Installation" with icon stop
HELP_DIALOG
    exit 1
fi

echo "‚úì Alle Dependencies installiert"
notify "Bereit!" "Alle Tools sind installiert"
echo ""

# Schritt 2: W√§hle Foto-Ordner
folder_path=$(osascript <<'APPLESCRIPT' 2>/dev/null
try
    set theFolder to choose folder with prompt "W√§hle einen Ordner mit Fotos:"
    return POSIX path of theFolder
on error
    return "ABGEBROCHEN"
end try
APPLESCRIPT
)

if [[ "$folder_path" == "ABGEBROCHEN" ]] || [[ -z "$folder_path" ]]; then
    exit 0
fi

# Entferne trailing slash
folder_path="${folder_path%/}"

echo "Gew√§hlter Ordner: $folder_path"

# Z√§hle Fotos im Ordner
photo_count=$(find "$folder_path" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.heic" -o -iname "*.heif" \) ! -name "._*" | wc -l | tr -d ' ')

if [ "$photo_count" -eq 0 ]; then
    show_error "Keine Fotos gefunden!\n\nUnterst√ºtzte Formate:\n‚Ä¢ JPG/JPEG\n‚Ä¢ PNG\n‚Ä¢ HEIC/HEIF"
    exit 1
fi

echo "Gefundene Fotos: $photo_count"

# Schritt 3: Zeige Optionen-Dialog
options_result=$(osascript <<APPLESCRIPT 2>/dev/null
try
    set theChoice to display dialog "üì∏ GPS Photo Renamer

üìÅ Ordner: $(basename "$folder_path")
üì∑ Fotos gefunden: $photo_count

W√§hle die gew√ºnschten Optionen:" buttons {"Abbrechen", "Optionen w√§hlen"} default button 2 with title "GPS Photo Renamer"

    if button returned of theChoice is "Abbrechen" then
        return "ABGEBROCHEN"
    end if

    -- Log-Modus Option
    set dryrunChoice to button returned of (display dialog "üìã Erst nur protokollieren (Log-Modus)?

Im Log-Modus werden keine Dateien ge√§ndert.
Du siehst zuerst, was passieren w√ºrde.

Nach dem Log kannst du direkt umbenennen." buttons {"Nein, direkt umbenennen", "Ja, erst Log anzeigen"} default button 2 with title "GPS Photo Renamer - Modus")

    -- Karten-Option
    set mapChoice to button returned of (display dialog "üó∫Ô∏è Kartenausschnitt hinzuf√ºgen?

Ein kleiner OpenStreetMap-Ausschnitt wird
rechts oben auf dem Foto angezeigt." buttons {"Nein", "Ja"} default button 2 with title "GPS Photo Renamer - Karte")

    -- Wenn Karte gew√ºnscht: Frage nach bereits bearbeiteten Fotos
    set reprocessMapChoice to "Nein"
    if mapChoice is "Ja" then
        set reprocessMapChoice to button returned of (display dialog "üîÑ Bereits bearbeitete Fotos nochmal mit Karte versehen?

Fotos die schon umbenannt wurden (aber noch keine Karte haben) k√∂nnen nachtr√§glich eine Karte bekommen." buttons {"Nein, nur neue", "Ja, alle mit Karte"} default button 1 with title "GPS Photo Renamer - Karte nachtr√§glich")
    end if

    -- Wasserzeichen und Geocoding immer aktiv, Unterordner nie
    set watermarkChoice to "Ja"
    set geocodingChoice to "Ja"
    set recursiveChoice to "Nein"

    return watermarkChoice & "|" & geocodingChoice & "|" & recursiveChoice & "|" & dryrunChoice & "|" & mapChoice & "|" & reprocessMapChoice

on error
    return "ABGEBROCHEN"
end try
APPLESCRIPT
)

echo "Optionen-Ergebnis: $options_result"

if [[ "$options_result" == "ABGEBROCHEN" ]] || [[ -z "$options_result" ]]; then
    exit 0
fi

# Parse Optionen
IFS='|' read -r WATERMARK GEOCODING RECURSIVE DRYRUN MAP_OPTION REPROCESS_MAP <<< "$options_result"

echo "Watermark: $WATERMARK"
echo "Geocoding: $GEOCODING"
echo "Recursive: $RECURSIVE"
echo "Dry-Run: $DRYRUN"
echo "Map: $MAP_OPTION"
echo "Reprocess Map: $REPROCESS_MAP"

# Baue Python-Argumente
PYTHON_ARGS=""

if [[ "$WATERMARK" == "Ja" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --watermark"
fi

if [[ "$GEOCODING" == "Nein" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --no-geocoding"
fi

if [[ "$RECURSIVE" == "Ja" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --recursive"
fi

if [[ "$MAP_OPTION" == "Ja" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --map"
fi

if [[ "$REPROCESS_MAP" == "Ja, alle mit Karte" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --reprocess-map"
fi

LOG_MODE="false"
if [[ "$DRYRUN" == "Ja, erst Log anzeigen" ]] || [[ "$DRYRUN" == "Ja, nur protokollieren" ]]; then
    PYTHON_ARGS="$PYTHON_ARGS --dry-run"
    LOG_MODE="true"
fi

echo "Python-Argumente: $PYTHON_ARGS"

# Schritt 4: Best√§tigung
confirm_result=$(osascript <<APPLESCRIPT 2>/dev/null
try
    set optionList to ""

    -- Immer aktiv
    set optionList to optionList & "‚Ä¢ Wasserzeichen: Ja ‚úì" & return
    set optionList to optionList & "‚Ä¢ GPS-Ortsnamen: Ja ‚úì" & return

    -- Karten-Option
    if "$MAP_OPTION" is "Ja" then
        set optionList to optionList & "‚Ä¢ Kartenausschnitt: Ja ‚úì" & return
        if "$REPROCESS_MAP" is "Ja, alle mit Karte" then
            set optionList to optionList & "‚Ä¢ Bereits bearbeitete: Mit Karte versehen" & return
        end if
    else
        set optionList to optionList & "‚Ä¢ Kartenausschnitt: Nein" & return
    end if

    if "$LOG_MODE" is "true" then
        set optionList to optionList & "‚Ä¢ Modus: Erst Log anzeigen" & return
    else
        set optionList to optionList & "‚Ä¢ Modus: Direkt umbenennen" & return
    end if

    set theChoice to button returned of (display dialog "üìã Zusammenfassung

üìÅ Ordner: $(basename "$folder_path")
üì∑ Fotos: $photo_count

Optionen:
" & optionList & "
Jetzt starten?" buttons {"Abbrechen", "Starten"} default button 2 with title "GPS Photo Renamer - Best√§tigung")

    return theChoice
on error
    return "ABGEBROCHEN"
end try
APPLESCRIPT
)

if [[ "$confirm_result" != "Starten" ]]; then
    exit 0
fi

# Schritt 5: Verarbeitung starten
notify "Verarbeitung l√§uft" "Fotos werden umbenannt..."

# Python-Script ist im Resources-Ordner der App eingebettet
SCRIPT_DIR="$(dirname "$0")/../Resources"
PYTHON_SCRIPT="$SCRIPT_DIR/gps_photo_renamer_smart_counter.py"

if [ ! -f "$PYTHON_SCRIPT" ]; then
    show_error "Python-Script nicht gefunden!\n\nDie App scheint besch√§digt zu sein."
    exit 1
fi

echo "Python-Script: $PYTHON_SCRIPT"
echo "Starte Verarbeitung..."

# F√ºhre Python-Script aus und fange Output auf
OUTPUT=$(python3 "$PYTHON_SCRIPT" "$folder_path" $PYTHON_ARGS 2>&1)
EXIT_CODE=$?

echo "$OUTPUT"
echo ""
echo "Exit-Code: $EXIT_CODE"

# Extrahiere Statistiken aus dem Output
FOUND=$(echo "$OUTPUT" | grep -o "Found:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
PROCESSED=$(echo "$OUTPUT" | grep -o "Processed:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
SKIPPED=$(echo "$OUTPUT" | grep -o "Skipped:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
VIDEOS=$(echo "$OUTPUT" | grep -o "Videos:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
VIDEO_SIZE=$(echo "$OUTPUT" | grep -o "Video Size:[[:space:]]*[0-9.]*" | grep -o "[0-9.]*" | tail -1)

# Fallback-Werte
FOUND=${FOUND:-$photo_count}
PROCESSED=${PROCESSED:-0}
SKIPPED=${SKIPPED:-0}
VIDEOS=${VIDEOS:-0}
VIDEO_SIZE=${VIDEO_SIZE:-0}

# Schritt 6: Ergebnis anzeigen
if [ $EXIT_CODE -eq 0 ]; then
    if [[ "$LOG_MODE" == "true" ]]; then
        # Log-Modus: Frage ob jetzt umbenennen
        # Baue Video-Info f√ºr Dialog
        VIDEO_INFO=""
        if [ "$VIDEOS" -gt 0 ]; then
            VIDEO_INFO="
üé¨ Videos gefunden: $VIDEOS (${VIDEO_SIZE} MB)"
        fi

        proceed_choice=$(osascript <<APPLESCRIPT 2>/dev/null
set theChoice to button returned of (display dialog "‚úÖ Protokoll erstellt!

üìä Vorschau:
‚Ä¢ Gefunden: $FOUND Fotos
‚Ä¢ W√ºrden umbenannt: $PROCESSED
‚Ä¢ W√ºrden √ºbersprungen: $SKIPPED${VIDEO_INFO}

üìÑ Log: ~/Desktop/gps_photo_renamer.log

Jetzt die Fotos wirklich umbenennen?" buttons {"Abbrechen", "Log √∂ffnen", "Jetzt umbenennen"} default button 3 with title "GPS Photo Renamer - Log fertig")
return theChoice
APPLESCRIPT
        )

        if [[ "$proceed_choice" == "Jetzt umbenennen" ]]; then
            notify "Umbenennen" "Fotos werden jetzt umbenannt..."

            # F√ºhre ohne dry-run aus
            REAL_ARGS="${PYTHON_ARGS/--dry-run/}"
            OUTPUT=$(python3 "$PYTHON_SCRIPT" "$folder_path" $REAL_ARGS 2>&1)
            EXIT_CODE=$?
            echo "$OUTPUT"

            # Neue Statistiken extrahieren (inkl. Videos)
            PROCESSED=$(echo "$OUTPUT" | grep -o "Processed:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
            VIDEOS=$(echo "$OUTPUT" | grep -o "Videos:[[:space:]]*[0-9]*" | grep -o "[0-9]*" | tail -1)
            VIDEO_SIZE=$(echo "$OUTPUT" | grep -o "Video Size:[[:space:]]*[0-9.]*" | grep -o "[0-9.]*" | tail -1)
            PROCESSED=${PROCESSED:-0}
            VIDEOS=${VIDEOS:-0}
            VIDEO_SIZE=${VIDEO_SIZE:-0}

            # Video-Info f√ºr Dialog
            VIDEO_INFO_LOG=""
            if [ "$VIDEOS" -gt 0 ]; then
                VIDEO_INFO_LOG="
üé¨ Videos: $VIDEOS (${VIDEO_SIZE} MB)"
            fi

            if [ $EXIT_CODE -eq 0 ]; then
                osascript <<APPLESCRIPT
display dialog "‚úÖ Fotos wurden umbenannt!

üìä Ergebnis:
‚Ä¢ Umbenannt: $PROCESSED Fotos${VIDEO_INFO_LOG}

üìÅ Schema: YYYYMMDDHHMMSS_NNNN_Ort_Land.jpg

üìÑ Log: ~/Desktop/gps_photo_renamer.log" buttons {"OK", "Ordner √∂ffnen"} default button 2 with title "GPS Photo Renamer - Fertig"

if button returned of result is "Ordner √∂ffnen" then
    tell application "Finder"
        activate
        open POSIX file "$folder_path"
    end tell
end if
APPLESCRIPT
                notify "Fertig!" "$PROCESSED Fotos umbenannt"

                # Video-L√∂schung anbieten (nach Log-Modus umbenennen)
                if [ "$VIDEOS" -gt 0 ]; then
                    video_delete_choice=$(osascript <<APPLESCRIPT 2>/dev/null
try
    set theChoice to button returned of (display dialog "üé¨ Videos gefunden!

Im Ordner wurden $VIDEOS Video-Dateien gefunden.
Gesamtgr√∂√üe: ${VIDEO_SIZE} MB

M√∂chtest du diese Videos l√∂schen?

‚ö†Ô∏è Dies kann nicht r√ºckg√§ngig gemacht werden!" buttons {"Behalten", "Videos l√∂schen"} default button 1 with title "GPS Photo Renamer - Videos" with icon caution)
    return theChoice
on error
    return "Behalten"
end try
APPLESCRIPT
                    )

                    if [[ "$video_delete_choice" == "Videos l√∂schen" ]]; then
                        echo "L√∂sche Videos..."
                        deleted_count=0
                        while IFS= read -r -d '' video_file; do
                            if [ -f "$video_file" ]; then
                                rm "$video_file"
                                echo "Gel√∂scht: $(basename "$video_file")"
                                ((deleted_count++))
                            fi
                        done < <(find "$folder_path" -maxdepth 1 -type f \( -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" -o -iname "*.m4v" -o -iname "*.3gp" -o -iname "*.webm" -o -iname "*.insv" -o -iname "*.lrv" \) ! -name "._*" -print0)

                        notify "Videos gel√∂scht" "$deleted_count Videos wurden entfernt"
                        osascript -e "display dialog \"üóëÔ∏è Videos gel√∂scht!\n\n$deleted_count Video-Dateien wurden entfernt.\" buttons {\"OK\"} default button 1 with title \"GPS Photo Renamer\""
                    fi
                fi
            else
                osascript <<APPLESCRIPT
display dialog "‚ùå Ein Fehler ist aufgetreten beim Umbenennen!

üìÑ Log: ~/Desktop/gps_photo_renamer.log" buttons {"OK"} default button 1 with title "GPS Photo Renamer - Fehler" with icon stop
APPLESCRIPT
            fi
        elif [[ "$proceed_choice" == "Log √∂ffnen" ]]; then
            open "$HOME/Desktop/gps_photo_renamer.log"
        fi
    else
        # Baue Video-Info f√ºr Dialog
        VIDEO_INFO_FINAL=""
        if [ "$VIDEOS" -gt 0 ]; then
            VIDEO_INFO_FINAL="
üé¨ Videos: $VIDEOS (${VIDEO_SIZE} MB)"
        fi

        osascript <<APPLESCRIPT
display dialog "‚úÖ Fotos wurden umbenannt!

üìä Ergebnis:
‚Ä¢ Gefunden: $FOUND Fotos
‚Ä¢ Umbenannt: $PROCESSED
‚Ä¢ √úbersprungen: $SKIPPED${VIDEO_INFO_FINAL}

üìÅ Die Fotos wurden nach dem Schema umbenannt:
   YYYYMMDDHHMMSS_NNNN_Ort_Land.jpg

üìÑ Log: ~/Desktop/gps_photo_renamer.log" buttons {"OK", "Ordner √∂ffnen"} default button 2 with title "GPS Photo Renamer - Fertig"

if button returned of result is "Ordner √∂ffnen" then
    tell application "Finder"
        activate
        open POSIX file "$folder_path"
    end tell
end if
APPLESCRIPT

        notify "Fertig!" "$PROCESSED Fotos verarbeitet"
    fi
else
    osascript <<APPLESCRIPT
display dialog "‚ùå Ein Fehler ist aufgetreten!

Bitte pr√ºfe das Log f√ºr Details:
~/Desktop/gps_photo_renamer.log" buttons {"OK"} default button 1 with title "GPS Photo Renamer - Fehler" with icon stop
APPLESCRIPT
fi

# Schritt 7: Frage nach Video-L√∂schung (wenn Videos gefunden)
if [ "$VIDEOS" -gt 0 ] && [ "$EXIT_CODE" -eq 0 ] && [[ "$LOG_MODE" != "true" ]]; then
    echo ""
    echo "Videos gefunden: $VIDEOS (${VIDEO_SIZE} MB)"

    # Extrahiere Video-Dateinamen aus dem Output
    VIDEO_LIST=$(echo "$OUTPUT" | grep -A100 "üé¨ Video files found:" | grep "^  ‚Ä¢" | head -10)

    video_delete_choice=$(osascript <<APPLESCRIPT 2>/dev/null
try
    set theChoice to button returned of (display dialog "üé¨ Videos gefunden!

Im Ordner wurden $VIDEOS Video-Dateien gefunden.
Gesamtgr√∂√üe: ${VIDEO_SIZE} MB

M√∂chtest du diese Videos l√∂schen?

‚ö†Ô∏è Dies kann nicht r√ºckg√§ngig gemacht werden!" buttons {"Behalten", "Videos l√∂schen"} default button 1 with title "GPS Photo Renamer - Videos" with icon caution)
    return theChoice
on error
    return "Behalten"
end try
APPLESCRIPT
    )

    if [[ "$video_delete_choice" == "Videos l√∂schen" ]]; then
        echo "L√∂sche Videos..."

        # Finde und l√∂sche alle Videos im Ordner
        deleted_count=0
        while IFS= read -r -d '' video_file; do
            if [ -f "$video_file" ]; then
                rm "$video_file"
                echo "Gel√∂scht: $(basename "$video_file")"
                ((deleted_count++))
            fi
        done < <(find "$folder_path" -maxdepth 1 -type f \( -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" -o -iname "*.m4v" -o -iname "*.3gp" -o -iname "*.webm" -o -iname "*.insv" -o -iname "*.lrv" \) ! -name "._*" -print0)

        notify "Videos gel√∂scht" "$deleted_count Videos wurden entfernt"

        osascript <<APPLESCRIPT
display dialog "üóëÔ∏è Videos gel√∂scht!

$deleted_count Video-Dateien wurden entfernt." buttons {"OK"} default button 1 with title "GPS Photo Renamer"
APPLESCRIPT
    else
        echo "Videos wurden behalten."
    fi
fi

echo ""
echo "=== FERTIG ==="
